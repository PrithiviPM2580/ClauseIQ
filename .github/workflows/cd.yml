name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
permissions:
  actions: read
  contents: read
jobs:
  Deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: CI
          name: frontend-dist
          path: frontend/dist
          workflow_conclusion: success
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download backend artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: CI
          name: backend-dist
          path: backend/dist
          workflow_conclusion: success
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy frontend build into backend public folder
        run: |
          rm -rf backend/public
          mkdir -p backend/public
          cp -r frontend/dist/* backend/public/

      - name: Deploy to Render
        run: |
          echo "ðŸš€ Triggering Render deployment..."
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
